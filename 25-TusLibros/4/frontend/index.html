<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tus Libros</title>

  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>

  <script src="./lib/react.development.js" crossorigin="anonymous"></script>
  <script src="./lib/react-dom.development.js" crossorigin="anonymous"></script>
  <script src="./lib/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="./lib/babel.min.js" crossorigin="anonymous"></script>
  <script src="./src/refreshbrowser.js" crossorigin="anonymous"></script>

  <!-- Libraries fallback -->
  <script>window.React || document.write('<script src="https://unpkg.com/react@16.11.0/umd/react.development.js">\x3C/script>')</script>
  <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@16.11.0/umd/react-dom.development.js">\x3C/script>')</script>
  <script>window.MaterialUI || document.write('<script src="https://unpkg.com/@material-ui/core@4.6.1/umd/material-ui.development.js">\x3C/script>')</script>
  <script>window.Babel || document.write('<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js">\x3C/script>')</script>
  <!-- end fallback -->

  <script type="text/babel" type="module">
    const {
      AppBar,
      Button,
      colors,
      Container,
      createMuiTheme,
      CssBaseline,
      Icon,
      InputAdornment,
      InputLabel,
      FormControl,
      Link,
      List,
      ListItem,
      ListItemIcon,
      ListItemText,
      ListItemSecondaryAction,
      IconButton,
      CommentIcon,
      makeStyles,
      OutlinedInput,
      TextField,
      ThemeProvider,
      Toolbar,
      Typography,
      Modal,
      Backdrop,
      Fade,
      Paper,
      Collapse,
      StarBorder,
    } = MaterialUI;
    const theme = createMuiTheme({
      palette: {
        primary: {
          main: '#556cd6',
        },
        secondary: {
          main: '#19857b',
        },
        error: {
          main: colors.red.A400,
        },
        background: {
          default: '#fff',
          paper: '#f5f5f5',
        },
      },
    });
    const useStyles = makeStyles(theme => ({
      root: {
        margin: theme.spacing(6, 0, 3),
      },
      lightBulb: {
        verticalAlign: 'middle',
        // marginRight: theme.spacing(1),
      },
      rootToolBar: {
        flexGrow: 1,
      },
      menuButton: {
        marginRight: theme.spacing(2),
      },
      textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(2),
      },
      title: {
        flexGrow: 1,
      },
      rootList: {
        width: '100%',
        backgroundColor: theme.palette.background.paper,
        position: 'relative',
        overflow: 'auto',
        maxHeight: 300,
      },
      textFieldDetails: {
        margin: theme.spacing(2),
      },
    
      modal: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      },
      paper: {
        backgroundColor: theme.palette.background.paper,
        border: '2px solid #000',
        boxShadow: theme.shadows[5],
        padding: theme.spacing(2, 4, 3),
      },
    }));

    const getLocalAsJson = (path) => {
    
      // var port = 8080
      var port = 8085
    
      return fetch(`http://localhost:${port}/${path}`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
    }
    const addToCart = (id, book, qty) => {
      return getLocalAsJson(`addToCart?cart_id=${id}&isbn=${book}&quantity=${qty}`)
        .catch(function (error) {
          console.log('Looks like there was a problem adding to cart: \n', error);
        });
    };
    
    const removeFromCart = (id, book) => {
      return getLocalAsJson(`removeFromCart?cart_id=${id}&isbn=${book}`)
        .catch(function (error) {
          console.log('Looks like there was a problem removing from cart: \n', error);
        });
    };
    
    const createCart = (username, password) => {
      return getLocalAsJson(`createCart?username=${username}&password=${password}`)
    };
    
    const listCart = (id) => {
      return getLocalAsJson(`listCart?id=${id}`)
    };
    
    const checkoutCart = (id, username, password) => {
      return getLocalAsJson(`checkout?cart_id=${id}&username=${username}&password=${password}`)
    };
    

    function MyToolBar(props) {
      const classes = useStyles();
      const {title, router, username } = props;
    
      let logoutButton = ( <IconButton
        edge="start"
        className={classes.menuButton}
        color="inherit"
        onClick={()=>router.navigate("/", { username: '', cartID: '' })}
      >
        <Icon>exit_to_app</Icon>
      </IconButton>
      )
    
      let cartButton = ( <IconButton
        edge="end"
        className={classes.menuButton}
        color="inherit"
        onClick={()=>router.navigate("/cart")} >
    
        <Icon>shopping_cart</Icon>
      </IconButton>
      )
    
      let catalogButton  = ( <IconButton
        edge="end"
        className={classes.menuButton}
        color="inherit"
        onClick={()=>router.navigate("/catalog")} >
    
        <Icon>store</Icon>
      </IconButton>
      )
    
      let purchrasesButton = ( <IconButton
        edge="end"
        className={classes.menuButton}
        color="inherit"
        onClick={()=>router.navigate("/purchrases")} >
    
        <Icon>history</Icon>
      </IconButton>
      )
    
      if (router.current() === "/catalog") {
        catalogButton  = null
      }
    
      if (router.current() === "/cart") {
        cartButton = null
      }
    
      if (router.current() === "/purchrases") {
        purchrasesButton = null
      }
    
      if (router.current() === "/") {
        logoutButton= null
        cartButton = null
        catalogButton  = null
        purchrasesButton = null
      }
    
      return (
        <div className={classes.rootToolBar}>
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" className={classes.title}>
                  {title} {username.length > 0 ? `- ${username}` : ''}
              </Typography>
              {catalogButton }
              {cartButton}
              {purchrasesButton}
              {logoutButton}
            </Toolbar>
          </AppBar>
        </div>
      )
    }
    function CreateCartForm(props) {
      const { router } = props
      const classes = useStyles();
    
      const [values, setValues] = React.useState({
        username: '',
        password: '',
      });
    
      const [error, setError] = React.useState(false)
    
      const handleChange = prop => event => {
        setValues({ ...values, [prop]: event.target.value });
      };
    
      const handleSend = (username, password) => {
        createCart(username,password)
          .then(function (response) {
            if(!response.ok) {
              throw Error(response)
            }
    
            return response.json()
          })
          .then(function (json) {
            router.navigate("/catalog", { username: username, password: password, cartID: json.cart_id })
          })
          .catch(function (error) {
            setError(true)
            setValues({ username: '', password: ''})
          });
      };
    
      return (
        <div>
          <Typography component="h1" gutterBottom>
              Welcome to Tus Libros <i>(Your Books)</i>, where your dreams come true....
              </Typography>
          <Typography component="h2" gutterBottom>
              Login to begin having fun
          </Typography>
    
         <form className={classes.container} noValidate autoComplete="off">
    
          <FormControl fullWidth className={classes.textField} variant="outlined">
              <TextField
                  required
                  id="outlined-required"
                  label="User"
                  className={classes.textField}
                  margin="normal"
                  variant="outlined"
                  value={values.username}
                  onChange={handleChange('username')}
                />
              <TextField
                required
                id="outlined-required"
                label="Password"
                className={classes.textField}
                margin="normal"
                variant="outlined"
                type="password"
                value={values.password}
                onChange={handleChange('password')}
              />
            </FormControl>
    
           { error &&
                <Typography component="p" color="error" gutterBottom>
                    Invalid user or password
                </Typography>
            }
    
          <Button
          variant="contained"
            className={classes.Button}
            style={{float: 'right'}}
            color="primary"
            onClick={() => handleSend(values.username, values.password)}>
            >
              Login
              </Button>
          </form>
        </div>
      )
    }
    function CatalogView(props) {
      const { router, cartID, catalog, cartContent, refreshCart } = props;
      const classes = useStyles();
    
      return (
        <div>
          <Typography variant="h4" component="h4" gutterBottom>
              Catalog
          </Typography>
    
          <List component="nav" className={classes.rootList} aria-label="catalog">
            {
              catalog.map(book => {
                let bookCount = cartContent.filter(isbn => isbn === book.isbn).length;
    
                return (
                  <BookListItem
                    key={book.isbn}
                    router={router}
                    cartID={cartID}
                    book={book}
                    quantity={bookCount}
                    handleAdd={() => addToCart(cartID, book.isbn, 1).then(refreshCart)}
                    handleRemove={() => removeFromCart(cartID, book.isbn).then(refreshCart)}
                  />
                )
              })
            }
          </List>
        </div>
      )
    }
    function CartView(props) {
      const { router, username, password, cartID, catalog, cartContent, refreshCart } = props;
      const classes = useStyles();
    
      const [checkoutModalOpen, setCheckoutModalOpen] = React.useState(false);
      const [ticket, setTicket] = React.useState({});
      const [error, setError] = React.useState(null)
    
      const bookByISBN = (isbn) => catalog.find(book => book.isbn === isbn)
    
      const handleCheckout = () => {
        checkoutCart(cartID, username, password)
          .then(function (response) {
            if(!response.ok) {
              throw response
            }
    
            return response.json()
          }).then(function (ticket) {
            setTicket(ticket)
    
            setCheckoutModalOpen(true);
          }).catch(function (error) {
            console.log(error)
            error.json().then(function(jsonError) {
              setError(jsonError)
            })
          });
      };
    
      const handleClose = () => {
        createCart(username,password)
          .then(function (response) {
            return response.json()
          })
          .then(function (json) {
            setCheckoutModalOpen(false);
            router.navigate("/catalog", { cartID: json.cart_id })
          })
      };
    
      if(cartContent.length == 0) {
        return (
          <div>
            <Typography variant="h4" component="h4" gutterBottom>
                Cart
            </Typography>
    
            <Typography variant="h5"  gutterBottom>
                Oops, Your cart is empty... why don't you buy something? :)
            </Typography>
          </div>
        )
      }
    
      let total = cartContent
        .map(isbn => bookByISBN(isbn).price)
        .reduce((x,y) => x + y, 0);
    
      return (
        <div>
          <Typography variant="h4" component="h4" gutterBottom>
              Cart
    
            <span style={{float: "right"}}>Total: ${total} </span>
          </Typography>
    
          <List component="nav" className={classes.rootList} aria-label="catalog">
            {
              catalog.filter(book => cartContent.includes(book.isbn)).map(book => {
                let bookCount = cartContent.filter(isbn => isbn === book.isbn).length;
    
                return (
                  <BookListItem
                    router={router}
                    key={book.isbn}
                    cartID={cartID}
                    book={book}
                    quantity={bookCount}
                    handleAdd={() => addToCart(cartID, book.isbn, 1).then(refreshCart)}
                    handleRemove={() => removeFromCart(cartID, book.isbn).then(refreshCart)}
                  />
                )
              })
            }
          </List>
    
          { error !== null &&
                <Typography component="p" color="error" gutterBottom>
                    {error.message}
                </Typography>
          }
    
          <Button
            variant="contained"
            className={classes.Button}
            style={{float: 'right', marginTop: "15px"}}
            color="primary"
            onClick={() => handleCheckout()}>
            >
              Checkout
              </Button>
    
         <Modal
            aria-labelledby="transition-modal-title"
            aria-describedby="transition-modal-description"
            className={classes.modal}
            open={checkoutModalOpen}
            onClose={handleClose}
            closeAfterTransition
            BackdropComponent={Backdrop}
            BackdropProps={{
              timeout: 500,
            }}
          >
            <Fade in={checkoutModalOpen}>
              <div className={classes.paper}>
                <Typography component="h1" id="transition-modal-title"><strong>Ticket</strong></Typography>
    
                <Paper className={classes.root} id="transition-modal-description">
                  <List component="nav" aria-label="main mailbox folders">
                    {
                      (ticket.items || []).map(item => {
                        return (
                          <ListItem key={item.name}>
                            <ListItemText primary={`${bookByISBN(item.name).name} X ${item.quantity} - $${item.total}`} secondary={`ISBN: ${item.name}`} />
                          </ListItem>
                        )
                      })
                    }
                  </List>
                </Paper>
    
                <Typography component="h3" id="transition-modal-title">Total: ${ticket.total}</Typography>
              </div>
            </Fade>
          </Modal>
        </div>
      )
    }
    function BookView(props) {
      const classes = useStyles();
      const { cartID, book, refreshCart, cartContent } = props;
    
      let quantity = cartContent.filter(isbn => isbn === book.isbn).length
    
      return (
        <div>
          <Paper className={classes.root} style={{padding: theme.spacing(3, 2)}}>
            <Typography variant="h4" component="h4" gutterBottom>
                {book.name}
            </Typography>
    
            <Typography variant="subtitle1" component="subtitle1" gutterBottom>
                By: {book.author} - ISBN: {book.isbn}
            </Typography>
    
            <Typography variant="p" component="p" style={{ marginTop: '10px' }} gutterBottom>
                {book.description}
            </Typography>
          </Paper>
    
          <Paper className={classes.root} style={{marginTop: '10px', padding: theme.spacing(3, 2)}}>
            <strong>Price ${book.price}</strong>
    
            <IconButton edge="end" aria-label="comments"
              onClick={() => addToCart(cartID, book.isbn, 1).then(refreshCart)}>
    
              <Icon>add_shopping_cart</Icon>
            </IconButton>
    
            <IconButton edge="end" aria-label="comments"
              disabled={quantity === 0}
              onClick={() => removeFromCart(cartID, book.isbn, 1).then(refreshCart)}>
              <Icon>remove_shopping_cart</Icon>
            </IconButton>
    
            <Typography variant="p" component="p" style={{ marginTop: '10px' }} color="textSecondary" gutterBottom>
                Quantity: {quantity}
            </Typography>
          </Paper>
        </div>
      )
    }
    
    const useFetchPurchrases = (username, password) => {
      const [purchrases, setPurchrases] = React.useState([])
      const [loading, setLoading] = React.useState(true)
      const [error, setError] = React.useState(null)
    
      React.useEffect(() => {
        getLocalAsJson(`listPurchrases?username=${username}&password=${password}`)
          .then(function (response) {
            return response.json()
          })
          .then(function (purchrases) {
            if(purchrases) {
              setPurchrases(purchrases)
            }
    
            setLoading(false)
          })
          .catch(err => {
            setError(err)
            setLoading(false)
          })
      }, [username])
    
      return { purchrases, loading, error }
    }
    
    function PurchrasesView(props) {
      const { router, username, password, catalog } = props;
      const classes = useStyles();
    
      let { purchrases, loading, error } = useFetchPurchrases(username, password)
    
      const bookByISBN = (isbn) => catalog.find(book => book.isbn === isbn)
    
      if (loading) { return <div>Loading...</div> }
      if (error) return <div>{error}</div>
    
      return (
        <div>
          <Typography variant="h4" component="h4" gutterBottom>
              Purchrases
          </Typography>
    
            { purchrases.length == 0 &&
                <Typography variant="h5"  gutterBottom>
                    You should buy something... ;)
                </Typography>
            }
    
            { purchrases.length > 0 &&
                <List component="nav" className={classes.rootList} aria-label="catalog">
                  {
                    purchrases.map(item => (
                      <ListItem key={item.name} dense >
                        <ListItemText
                          primary={`${bookByISBN(item.name).name} - $${item.total}`}
                          secondary={`ISBN: ${item.name} - Quantity: ${item.quantity}`}
                        />
                      </ListItem>
                    ))
                  }
                </List>
            }
    
        </div>
      )
    }
    function BookListItem(props) {
      const { router, cartID, book, quantity, handleAdd, handleRemove } = props;
      const classes = useStyles();
    
      let bookCountString = '';
    
      if(quantity > 0) {
        bookCountString = ` - (${quantity})`;
      }
    
      return (
        <ListItem
          key={book}
          dense
          button
          onClick={() => {router.navigate('/book', { selectedBook: book })}}
        >
          <ListItemText primary={<React.Fragment>
              <Typography
                component="span"
                variant="body2"
                className={classes.inline}
                color="textPrimary"
              >
                  {`${book.name} - $${book.price}`}
            </Typography>
            <Typography
              component="span"
              variant="body2"
              className={classes.inline}
              color="textSecondary"
            >
                {bookCountString}
            </Typography>
          </React.Fragment>
          } />
    
          <ListItemSecondaryAction>
            <IconButton edge="end" aria-label="comments"
              onClick={handleAdd}>
    
              <Icon>add_shopping_cart</Icon>
            </IconButton>
    
            <IconButton edge="end" aria-label="comments"
              disabled={quantity === 0}
              onClick={handleRemove}>
              <Icon>remove_shopping_cart</Icon>
            </IconButton>
          </ListItemSecondaryAction>
        </ListItem>
      )
    }
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          path: "/",
          username: '',
          password: '',
          cartID: null,
          catalog: [],
          cartContent: [],
          selectedBook: {},
        };
      }
    
      refreshCart = () => {
        if(!this.state.cartID) {
          this.setState({ cartContent: [] })
          return
        }
    
        listCart(this.state.cartID)
          .then(response => {
            return response.json()
          }).then(cartContent => {
            this.setState({ cartContent: cartContent })
          })
      }
    
      componentDidMount() {
        getLocalAsJson(`catalog`)
          .then(response => {
            return response.json()
          }).then(catalog => {
            this.setState({ catalog: catalog })
          })
      }
    
      componentDidUpdate(prevProps, prevState) {
        if(prevState.cartID !== this.state.cartID) {
          this.refreshCart()
        }
      }
    
      render() {
        let title = "Tus Libros"
        let content = "Where am I?"
        const router = {
          current: () => this.state.path,
          navigate: (path, state) => {
            // http://es6-features.org/#SpreadOperator
            this.setState({ ...state, path: path })
          }
        }
    
        if (this.state.path === "/") {
          content = (<CreateCartForm router={router} />)
        } else if (this.state.path === "/catalog") {
          content = (<CatalogView
            router={router}
            cartID={this.state.cartID}
            catalog={this.state.catalog}
            cartContent={this.state.cartContent}
            refreshCart={this.refreshCart}
          />)
        } else if (this.state.path === "/cart") {
          content = (<CartView
            router={router}
            username={this.state.username}
            password={this.state.password}
            cartID={this.state.cartID}
            catalog={this.state.catalog}
            cartContent={this.state.cartContent}
            refreshCart={this.refreshCart}
          />)
        } else if (this.state.path === "/purchrases") {
          content = (<PurchrasesView
            router={router}
            username={this.state.username}
            password={this.state.password}
            catalog={this.state.catalog}
          />)
        } else if (this.state.path === "/book") {
          content = (<BookView
            book={this.state.selectedBook}
            cartID={this.state.cartID}
            cartContent={this.state.cartContent}
            refreshCart={this.refreshCart}
          />)
        }
        return (
          <div>
            <MyToolBar
              title={title}
              router={router}
              username={this.state.username}
            />
            <Container maxWidth="sm">
              <div style={{ marginTop: 24, }}>
                {content}
              </div>
            </Container>
          </div>
        );
      }
    }

    ///////////////////////////////////////////////////////////////////////////
    // Initial render
    //
    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <App />
      </ThemeProvider>,
      document.getElementById('root')
    )
  </script>

  <!-- <button onclick="window.location.reload(true)">reload</button> -->
</body>

</html>
